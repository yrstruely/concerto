// Auto-generated by the postman-to-k6 converter

import "./libs/shim/core.js";
import "./libs/shim/expect.js";
import "./libs/shim/urijs.js";
import "./libs/shim/cheerio.js";
import URI from "./libs/urijs.js";
import cheerio from "./libs/cheerio.js"
import { group } from "k6";
import dotenv from "k6/x/dotenv";

const PROJECT_DIR = '../'
const env = dotenv.parse(open(PROJECT_DIR + ".env.test.local"));
const data = JSON.parse(open(PROJECT_DIR + "results/data.json"));
console.log(data)


export let options = {
  maxRedirects: 4,
  stages: [
    { target: 1, duration: '5s' },
    //{ target: 10, duration: '120s' },
    //{ target: 0, duration: '30s' }
  ],
  thresholds: {
    // the rate of successful checks should be higher than 90%
    checks: ['rate>0.9'],
  },
};

const Pre = Symbol.for("pre");
const Request = Symbol.for("request");
postman[Symbol.for("initial")]({
  options,
  collection: {
    baseUrl: "/",
    variable_key: ""
  },
  environment: {
    env: "tst",
    SAP_Instance: env.IAPPROVE_SAP_INSTANCE,
    baseUrl: `${env.IAPPROVE_TNE_EXP_BASE_URL}${env.IAPPROVE_TNE_EXP_URL_PATH}`,
    client_id: env.IAPPROVE_TNE_EXP_CLIENT_ID,
    client_secret: env.IAPPROVE_TNE_EXP_CLIENT_SECRET,
    delegationId: "4915",
    userID: "RAMACHA8",
    taskType: "invoiceSAP",
    role: 1,
    fullName: "Arun Ramachandran",
    startDate: "2021-11-30T11:00:00.000Z",
    endDate: "2021-12-09T11:00:00.000Z",
    toMe: "true",
    delegationType: 1,
    permissionScope: 1,
    query: "arun",
    offset: "0",
    limit: "10",
    beginDate: "2021-11-09T11:00:00.000Z",
    xDelegations: "10",
    OauthUrl:
      "https://go-{{env}}.test.fonterra.com/sap/bc/sec/oauth2/authorize?sap-client=100&response_type=code&client_id=MULEINT&redirect_uri=https%3A%2F%2Fanypoint.mulesoft.com%2Fexchange%2FoauthCallback.html&scope={{scope}}&state=anystate",
    muleint: env.IAPPROVE_MULEINT,
    sourceSystem: "ANZ_ECC",
    detailed: "true",
    documentNumber: "123456",
    documentYear: "2021",
    decision: "Rejected",
    attachmentCount: "0",
    scope: env.IAPPROVE_SCOPE,
    prTaskId: "5000824182",
    prID: "5000824108",
    prCount: 2,
    "sap-password": env.IAPPROVE_SAP_PASSWORD,
    "sap-user": env.IAPPROVE_SAP_USER,
    workOrderNumber: "",
    isEnabled: 1,
    instanceId: "",
    isntanceIdCollection: "[null,null,null]"
  }
});

export default function () {
  group("Integration Tests", function () {
    group("Setup", function () {
      postman[Pre].push(() => {
        var startDate = new Date();
        var endDate = new Date();
        startDate.setDate(new Date().getDate() + 1);
        startDate.setHours(0, 0, 0, 0);
        endDate.setDate(new Date().getDate() + 10);
        endDate.setHours(0, 0, 0, 0);

        pm.environment.set("startDate", startDate.toISOString());
        pm.environment.set("endDate", endDate.toISOString());

        //2020-10-17T00:00:00Z
        console.log(startDate);
        console.log(endDate);
      });

      postman[Request]({
        name: "Setup script",
        id: "d7621cc3-5bab-49b5-8db9-b3cdf1de6b70",
        method: "GET",
        address: "https://devnull-as-a-service.com/dev/null",
        pre() {
          var beginDate = new Date();
          var endDate = new Date();
          beginDate.setDate(new Date().getDate() + 1);
          beginDate.setHours(0, 0, 0, 0);
          endDate.setDate(new Date().getDate() + 10);
          endDate.setHours(0, 0, 0, 0);

          pm.environment.set("beginDate", beginDate.toISOString());
          pm.environment.set("endDate", endDate.toISOString());

          //2020-10-17T00:00:00Z
          console.log(beginDate);
          console.log(endDate);
        },
        auth(config, Var) {
          config.headers.Authorization = `Bearer ${pm[Var]("oAuthToken")}`;
        }
      });

      postman[Pre].pop();
    });

    group("OAuth", function () {
      postman[Request]({
        name: "OAuth Login",
        id: "13ea25d5-7dc8-448e-a691-9d41d5471a52",
        method: "GET",
        address:
          "https://go-{{env}}.test.fonterra.com/sap/bc/sec/oauth2/authorize?sap-client=100&response_type=code&client_id=MULEINT&redirect_uri=https%253A%252F%252Fanypoint.mulesoft.com%252Fexchange%252FoauthCallback.html&scope={{scope}}&state=anystate",
        pre() {
          const env = pm.environment.get("env");
        },
        post(response) {
          var responseHtml = cheerio(pm.response.text());

          pm.test("Status code is 200", function () {
            pm.response.to.have.status(200);
          });

          var sapLoginXSRF = responseHtml.find('[name="sap-login-XSRF"]').val();

          if (sapLoginXSRF != null) {
            pm.globals.set("sapLoginXSRF", sapLoginXSRF);
            console.log(sapLoginXSRF);

            var SAP_Instance = pm.environment.get("SAP_Instance");

            pm.test("Response should return X-CSRF Tracking Token", function () {
              var SAP_Login_XSRF = null;
              var regex = new RegExp(`^sap-login-XSRF_${SAP_Instance}=.*`);
              console.log(JSON.stringify(response.headers));
              for (const responseHeader in response.headers) {
                if (responseHeader.toLowerCase() === 'set-cookie' &&
                  response.headers[responseHeader].match(regex)) {
                  console.log(response.headers[responseHeader])
                  SAP_Login_XSRF = response.headers[responseHeader];

                }
              }
              pm.expect(SAP_Login_XSRF).not.null;

              regex = new RegExp(
                `^(sap-login-XSRF_${SAP_Instance}=.*;) .ath.*`
              );
              SAP_Login_XSRF = SAP_Login_XSRF.match(regex)[1];
              pm.globals.set("Cookie", SAP_Login_XSRF);
            });
          } else {
            console.log("sapLoginXSRF is null");
          }
        }
      });

      postman[Request]({
        name: "OAuth Submit Login",
        id: "0c243e90-304b-4af0-894f-5a4ebf9f1df8",
        method: "POST",
        address:
          "https://go-{{env}}.test.fonterra.com/sap/bc/sec/oauth2/authorize/index.html?response_type=code&client_id=MULEINT&redirect_uri=https%253a%252f%252fanypoint.mulesoft.com%252fexchange%252foauthCallback.html&scope={{scope}}&state=anystate",
        data: {
          "sap-system-login-oninputprocessing": "onLogin",
          "sap-urlscheme": "",
          "sap-system-login": "onLogin",
          "sap-system-login-basic_auth": "",
          "sap-accessibility": "",
          "sap-login-XSRF": "{{sapLoginXSRF}}",
          "sap-system-login-cookie_disabled": "",
          "sap-hash": "",
          "sap-language": "EN",
          "sap-user": "{{sap-user}}",
          "sap-password": "{{sap-password}}",
          "sap-client": "100"
        },
        headers: {
          Connection: "keep-alive",
          "Cache-Control": "max-age=0",
          "sec-ch-ua":
            '"Google Chrome";v="89", "Chromium";v="89", ";Not A Brand";v="99"',
          "sec-ch-ua-mobile": "?0",
          "Upgrade-Insecure-Requests": "1",
          Origin: "https://go-{{env}}.test.fonterra.com",
          "Content-Type": "application/x-www-form-urlencoded",
          "User-Agent":
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36",
          Accept:
            "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
          "Sec-Fetch-Site": "same-origin",
          "Sec-Fetch-Mode": "navigate",
          "Sec-Fetch-User": "?1",
          "Sec-Fetch-Dest": "document",
          Referer:
            "https://go-{{env}}.test.fonterra.com/sap/bc/sec/oauth2/authorize/index.html?response_type=code&client_id=MULEINT&redirect_uri=https%3a%2f%2fanypoint.mulesoft.com%2fexchange%2foauthCallback.html&scope={{scope}}&sap-language=EN",
          "Accept-Language": "en-US,en;q=0.9",
          Cookie:
            "sap-login-XSRF_{{SAP_Instance}}={{sapLoginXSRF}}; sap-usercontext=sap-language=EN&sap-client=100; BIGipServerEP_FIORY_TEST_POOL=u0021IBLhO7+/Ppt5y3voxdJ9YJJeVN0dK+7PW8Lgo39N8Pz0uPK8PcI2tC+O1g10UH05iJScPiIkbus8DvA=; AzureAppProxyAnalyticCookie_268746a4-02c1-45df-8a54-80490a6ab26b_1.3=3|ZsH8fOARlZhzGtnmCX4XewMUqQZALaBmHb/ukvmA03vaYzG2dPR3DL/hwl6GDI1hyG92Q6anoxTsqol9hhmdssumvugt8P8LCH63tbqYtN0Uc/mZ26+/0DaRPd7B6P7s4M5xqwXQyNndbH3I1SLxhQ=="
        }
      });

      postman[Request]({
        name: "OAuth Accept Scopes",
        id: "1dffaa17-a54b-4be3-bd67-181e3a3b28b8",
        method: "GET",
        address:
          "https://go-{{env}}.test.fonterra.com/sap/bc/sec/oauth2/authorize/index.html?response_type=code&client_id=MULEINT&redirect_uri=https%253a%252f%252fanypoint.mulesoft.com%252fexchange%252foauthCallback.html&scope={{scope}}&state=anystate&sap-client=100&sap-language=EN",
        headers: {
          Connection: "keep-alive",
          "Cache-Control": "max-age=0",
          "Upgrade-Insecure-Requests": "1",
          "User-Agent":
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36",
          Accept:
            "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
          "Sec-Fetch-Site": "same-origin",
          "Sec-Fetch-Mode": "navigate",
          "Sec-Fetch-User": "?1",
          "Sec-Fetch-Dest": "document",
          "sec-ch-ua":
            '"Google Chrome";v="89", "Chromium";v="89", ";Not A Brand";v="99"',
          "sec-ch-ua-mobile": "?0",
          Referer:
            "https://go-{{env}}.test.fonterra.com/sap/bc/sec/oauth2/authorize?sap-client=100&response_type=code&client_id=MULEINT&redirect_uri=https%3A%2F%2Fanypoint.mulesoft.com%2Fexchange%2FoauthCallback.html&scope={{scope}}&state=anystate",
          "Accept-Language": "en-US,en;q=0.9",
          Cookie:
            "BIGipServerEP_FIORY_DEV_POOL=u0021ggETvoGAW/Qdi/zoxdJ9YJJeVN0dK8N8A0j+OZOGemaev1CwUjr805ejuUexNZ41ZdEFMO4Q2k0Xkjg=; AzureAppProxyAnalyticCookie_ddd7ed7a-bba4-475d-a48e-f21bf639f1b9_1.3=3|hANm/K86gpXBfjCJGWJxj4UboR+iqwodcHgfTy19+hW31+GnM2PB3Tm2cZ+mu7iprR/qqZ1WHPp5Ins3HwjhhnFqcF5btADiPBHZEsVk4pvhpWpsGk6IaVu/arw5/1IzFU7xHqu7CiN1z6I0/F2Ohw==; MYSAPSSO2=AjQxMDMBABhaAFoAXwBIAEEAUgBSAEkAUwBLADYAIAACAAYxADAAMAADABBGAEQAMAAgACAAIAAgACAABAAYMgAwADIAMQAwADMAMQA4ADAAMwAwADcABQAEAAAACAYAAlgACQACRQD%2fAPwwgfkGCSqGSIb3DQEHAqCB6zCB6AIBATELMAkGBSsOAwIaBQAwCwYJKoZIhvcNAQcBMYHIMIHFAgEBMBowDjEMMAoGA1UEAxMDRkQwAggKIBUQICNWATAJBgUrDgMCGgUAoF0wGAYJKoZIhvcNAQkDMQsGCSqGSIb3DQEHATAcBgkqhkiG9w0BCQUxDxcNMjEwMzE4MDMwNzI2WjAjBgkqhkiG9w0BCQQxFgQUJgDWPwUu5no1prDd6cg5sVrP1VgwCQYHKoZIzjgEAwQvMC0CFD7OznQED2XupdiaAV%21iUPGkkAxsAhUAlSNJ30gbsLzo4GFSjC%21JtBLvRq4%3d; SAP_SESSIONID_FD0_100=RWCeAFm5Z0KBDUNswq1eoRDaJWCHlxHrghEAUFazLpo%3d; sap-usercontext=sap-language=EN&sap-client=100"
        }
      });

      postman[Request]({
        name: "OAuth XSRF",
        id: "d2965d31-7da4-4b52-a40d-d2a2dbf981d6",
        method: "GET",
        address:
          "https://go-{{env}}.test.fonterra.com/sap/bc/sec/oauth2/auth_ui_service/xsrf",
        headers: {
          Connection: "keep-alive",
          "sec-ch-ua":
            '"Google Chrome";v="89", "Chromium";v="89", ";Not A Brand";v="99"',
          Accept: "*/*",
          "X-CSRF-Token": "Fetch",
          "X-Requested-With": "XMLHttpRequest",
          "sec-ch-ua-mobile": "?0",
          "User-Agent":
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36",
          "SAP-PASSPORT":
            "2A54482A0300E60000756E64657465726D696E6564202020202020202020202020202020202020202000005341505F4532455F54415F557365722020202020202020202020202020202020756E64657465726D696E65645F737461727475705F302020202020202020202020202020202020200005756E64657465726D696E65642020202020202020202020202020202020202020433542423431333632413143343739354236314339323031383143313539323720202000078BA9DB79989B4B55B2807AC7E45883030000000000000000000000000000000000000000000000E22A54482A",
          "Sec-Fetch-Site": "same-origin",
          "Sec-Fetch-Mode": "cors",
          "Sec-Fetch-Dest": "empty",
          Referer:
            "https://go-{{env}}.test.fonterra.com/sap/bc/sec/oauth2/authorize/index.html?response_type=code&client_id=MULEINT&redirect_uri=https%3a%2f%2fanypoint.mulesoft.com%2fexchange%2foauthCallback.html&scope={{scope}}&sap-language=EN",
          "Accept-Language": "en-US,en;q=0.9",
          Cookie:
            "BIGipServerEP_FIORY_DEV_POOL=u0021ggETvoGAW/Qdi/zoxdJ9YJJeVN0dK8N8A0j+OZOGemaev1CwUjr805ejuUexNZ41ZdEFMO4Q2k0Xkjg=; AzureAppProxyAnalyticCookie_ddd7ed7a-bba4-475d-a48e-f21bf639f1b9_1.3=3|hANm/K86gpXBfjCJGWJxj4UboR+iqwodcHgfTy19+hW31+GnM2PB3Tm2cZ+mu7iprR/qqZ1WHPp5Ins3HwjhhnFqcF5btADiPBHZEsVk4pvhpWpsGk6IaVu/arw5/1IzFU7xHqu7CiN1z6I0/F2Ohw==; MYSAPSSO2=AjQxMDMBABhaAFoAXwBIAEEAUgBSAEkAUwBLADYAIAACAAYxADAAMAADABBGAEQAMAAgACAAIAAgACAABAAYMgAwADIAMQAwADMAMQA4ADAAMwAwADcABQAEAAAACAYAAlgACQACRQD%2fAPwwgfkGCSqGSIb3DQEHAqCB6zCB6AIBATELMAkGBSsOAwIaBQAwCwYJKoZIhvcNAQcBMYHIMIHFAgEBMBowDjEMMAoGA1UEAxMDRkQwAggKIBUQICNWATAJBgUrDgMCGgUAoF0wGAYJKoZIhvcNAQkDMQsGCSqGSIb3DQEHATAcBgkqhkiG9w0BCQUxDxcNMjEwMzE4MDMwNzI2WjAjBgkqhkiG9w0BCQQxFgQUJgDWPwUu5no1prDd6cg5sVrP1VgwCQYHKoZIzjgEAwQvMC0CFD7OznQED2XupdiaAV%21iUPGkkAxsAhUAlSNJ30gbsLzo4GFSjC%21JtBLvRq4%3d; SAP_SESSIONID_FD0_100=RWCeAFm5Z0KBDUNswq1eoRDaJWCHlxHrghEAUFazLpo%3d; sap-usercontext=sap-language=EN&sap-client=100"
        },
        post(response) {
          pm.test("Response should return an x-csrf-token", function () {
            var OAuth_X_CSRF_Token = null;
            console.log(JSON.stringify(response.headers));
            for (const responseHeader in response.headers) {
              if (responseHeader.toLowerCase() === 'x-csrf-token') {
                console.log(response.headers[responseHeader])
                OAuth_X_CSRF_Token = response.headers[responseHeader];
              }
            }
            pm.expect(OAuth_X_CSRF_Token).to.exist;

            pm.globals.set("OAuth_X_CSRF_Token", OAuth_X_CSRF_Token);
          });
        }
      });

      postman[Request]({
        name: "OAuth Prepare",
        id: "278a7839-489c-4e85-8e06-24d4424cb98a",
        method: "POST",
        address:
          "https://go-{{env}}.test.fonterra.com/sap/bc/sec/oauth2/auth_ui_service/prepare",
        data:
          "response_type=code&state=anystate&client_id=MULEINT&redirect_uri=https://anypoint.mulesoft.com/exchange/oauthCallback.html&scope=ZAPI_IAPR_PURCH_REQ_ITEM_SRV_0001 ZUSER_SRV_0001 ZTASKPROCESSING_0002 ZGOS_SRV_01_0001 Z_VENDOR_INVOICE_APPROVAL_SRV_0001 ZTASKPROCESSING_V2_SRV_0001",
        headers: {
          Connection: "keep-alive",
          "sec-ch-ua":
            '"Google Chrome";v="89", "Chromium";v="89", ";Not A Brand";v="99"',
          "X-CSRF-Token": "{{OAuth_X_CSRF_Token}}",
          "sec-ch-ua-mobile": "?0",
          "User-Agent":
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36",
          "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
          Accept: "application/json, text/javascript, */*; q=0.01",
          "X-Requested-With": "XMLHttpRequest",
          "SAP-PASSPORT":
            "2A54482A0300E60000756E64657465726D696E6564202020202020202020202020202020202020202000005341505F4532455F54415F557365722020202020202020202020202020202020756E64657465726D696E65645F737461727475705F302020202020202020202020202020202020200005756E64657465726D696E65642020202020202020202020202020202020202020313039373341463546453637343143363930383539443030383331434632434420202000078BA9DB79989B4B55B2807AC7E45883030000000000000000000000000000000000000000000000E22A54482A",
          Origin: "https://go-{{env}}.test.fonterra.com",
          "Sec-Fetch-Site": "same-origin",
          "Sec-Fetch-Mode": "cors",
          "Sec-Fetch-Dest": "empty",
          Referer:
            "https://go-{{env}}.test.fonterra.com/sap/bc/sec/oauth2/authorize/index.html?response_type=code&client_id=MULEINT&redirect_uri=https%3a%2f%2fanypoint.mulesoft.com%2fexchange%2foauthCallback.html&scope={{scope}}&sap-language=EN",
          "Accept-Language": "en-US,en;q=0.9",
          Cookie:
            "BIGipServerEP_FIORY_DEV_POOL=u0021ggETvoGAW/Qdi/zoxdJ9YJJeVN0dK8N8A0j+OZOGemaev1CwUjr805ejuUexNZ41ZdEFMO4Q2k0Xkjg=; AzureAppProxyAnalyticCookie_ddd7ed7a-bba4-475d-a48e-f21bf639f1b9_1.3=3|hANm/K86gpXBfjCJGWJxj4UboR+iqwodcHgfTy19+hW31+GnM2PB3Tm2cZ+mu7iprR/qqZ1WHPp5Ins3HwjhhnFqcF5btADiPBHZEsVk4pvhpWpsGk6IaVu/arw5/1IzFU7xHqu7CiN1z6I0/F2Ohw==; MYSAPSSO2=AjQxMDMBABhaAFoAXwBIAEEAUgBSAEkAUwBLADYAIAACAAYxADAAMAADABBGAEQAMAAgACAAIAAgACAABAAYMgAwADIAMQAwADMAMQA4ADAAMwAwADcABQAEAAAACAYAAlgACQACRQD%2fAPwwgfkGCSqGSIb3DQEHAqCB6zCB6AIBATELMAkGBSsOAwIaBQAwCwYJKoZIhvcNAQcBMYHIMIHFAgEBMBowDjEMMAoGA1UEAxMDRkQwAggKIBUQICNWATAJBgUrDgMCGgUAoF0wGAYJKoZIhvcNAQkDMQsGCSqGSIb3DQEHATAcBgkqhkiG9w0BCQUxDxcNMjEwMzE4MDMwNzI2WjAjBgkqhkiG9w0BCQQxFgQUJgDWPwUu5no1prDd6cg5sVrP1VgwCQYHKoZIzjgEAwQvMC0CFD7OznQED2XupdiaAV%21iUPGkkAxsAhUAlSNJ30gbsLzo4GFSjC%21JtBLvRq4%3d; SAP_SESSIONID_FD0_100=RWCeAFm5Z0KBDUNswq1eoRDaJWCHlxHrghEAUFazLpo%3d; sap-usercontext=sap-language=EN&sap-client=100"
        }
      });

      postman[Request]({
        name: "OAuth Allow",
        id: "dc043ad8-a61a-4d24-b58e-04cd7f380d1b",
        method: "POST",
        address:
          "https://go-{{env}}.test.fonterra.com/sap/bc/sec/oauth2/auth_ui_service/allow",
        data:
          "response_type=code&state=anystate&client_id=MULEINT&redirect_uri=https://anypoint.mulesoft.com/exchange/oauthCallback.html&scope=ZAPI_IAPR_PURCH_REQ_ITEM_SRV_0001 ZUSER_SRV_0001 ZTASKPROCESSING_0002 ZGOS_SRV_01_0001 Z_VENDOR_INVOICE_APPROVAL_SRV_0001 ZTASKPROCESSING_V2_SRV_0001 ",
        headers: {
          Connection: "keep-alive",
          "sec-ch-ua":
            '"Google Chrome";v="89", "Chromium";v="89", ";Not A Brand";v="99"',
          "SAP-Perf-FESRec-opt":
            "undetermined,undetermined_click,,cr_89,8298,30607,,,0,,,,,,0,,,,",
          "X-CSRF-Token": "{{OAuth_X_CSRF_Token}}",
          "sec-ch-ua-mobile": "?0",
          "User-Agent":
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36",
          "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
          Accept: "*/*",
          "SAP-Perf-FESRec":
            "8BA9DB79989B4B55B2807AC7E4588303,805694FB58884CE98EA03A8C9046365B,91,533,519,15,03FCA35D8BA9DB79989B4B55B2807AC7E4588303,33,547,win_10,SAP_UI5",
          "X-Requested-With": "XMLHttpRequest",
          "SAP-PASSPORT":
            "2A54482A0300E60000756E64657465726D696E6564202020202020202020202020202020202020202000005341505F4532455F54415F5573657220202020202020202020202020202020206964427574746F6E4163636570745F636C69636B5F312020202020202020202020202020202020200005756E64657465726D696E65642020202020202020202020202020202020202020344637394542464638334246343230303839413131344636354641354445304120202000078BA9DB79989B4B55B2807AC7E45883030000000000000000000000000000000000000000000000E22A54482A",
          Origin: "https://go-{{env}}.test.fonterra.com",
          "Sec-Fetch-Site": "same-origin",
          "Sec-Fetch-Mode": "cors",
          "Sec-Fetch-Dest": "empty",
          Referer:
            "https://go-{{env}}.test.fonterra.com/sap/bc/sec/oauth2/authorize/index.html?response_type=code&client_id=MULEINT&redirect_uri=https%3a%2f%2fanypoint.mulesoft.com%2fexchange%2foauthCallback.html&scope={{scope}}&state=anystate&sap-client=100&sap-language=EN",
          "Accept-Language": "en-US,en;q=0.9",
          Cookie:
            "BIGipServerEP_FIORY_DEV_POOL=u0021ggETvoGAW/Qdi/zoxdJ9YJJeVN0dK8N8A0j+OZOGemaev1CwUjr805ejuUexNZ41ZdEFMO4Q2k0Xkjg=; AzureAppProxyAnalyticCookie_ddd7ed7a-bba4-475d-a48e-f21bf639f1b9_1.3=3|hANm/K86gpXBfjCJGWJxj4UboR+iqwodcHgfTy19+hW31+GnM2PB3Tm2cZ+mu7iprR/qqZ1WHPp5Ins3HwjhhnFqcF5btADiPBHZEsVk4pvhpWpsGk6IaVu/arw5/1IzFU7xHqu7CiN1z6I0/F2Ohw==; MYSAPSSO2=AjQxMDMBABhaAFoAXwBIAEEAUgBSAEkAUwBLADYAIAACAAYxADAAMAADABBGAEQAMAAgACAAIAAgACAABAAYMgAwADIAMQAwADMAMQA4ADAAMwAwADcABQAEAAAACAYAAlgACQACRQD%2fAPwwgfkGCSqGSIb3DQEHAqCB6zCB6AIBATELMAkGBSsOAwIaBQAwCwYJKoZIhvcNAQcBMYHIMIHFAgEBMBowDjEMMAoGA1UEAxMDRkQwAggKIBUQICNWATAJBgUrDgMCGgUAoF0wGAYJKoZIhvcNAQkDMQsGCSqGSIb3DQEHATAcBgkqhkiG9w0BCQUxDxcNMjEwMzE4MDMwNzI2WjAjBgkqhkiG9w0BCQQxFgQUJgDWPwUu5no1prDd6cg5sVrP1VgwCQYHKoZIzjgEAwQvMC0CFD7OznQED2XupdiaAV%21iUPGkkAxsAhUAlSNJ30gbsLzo4GFSjC%21JtBLvRq4%3d; SAP_SESSIONID_FD0_100=RWCeAFm5Z0KBDUNswq1eoRDaJWCHlxHrghEAUFazLpo%3d; sap-usercontext=sap-language=EN&sap-client=100"
        },
        post(response) {
          var jsonData = pm.response.json();
          var oAuthCode = null;

          pm.test("Your test name", function () {
            pm.expect(jsonData.redirect_uri).to.exist;
            oAuthCode = jsonData.redirect_uri.split("=")[1].split("&")[0];
            console.log(oAuthCode);
            pm.globals.set("oAuthCode", oAuthCode);
          });
        }
      });

      postman[Request]({
        name: "OAuth Token",
        id: "6b5fb356-6af1-4824-98c9-282792b29e7e",
        method: "POST",
        address:
          "https://go-{{env}}.test.fonterra.com/sap/bc/sec/oauth2/token?sap-client=100",
        data: {
          grant_type: "authorization_code",
          code: "{{oAuthCode}}",
          redirect_uri:
            "https://anypoint.mulesoft.com/exchange/oauthCallback.html"
        },
        post(response) {
          var jsonData = pm.response.json();
          var oAuthToken = null;

          pm.test("Response should contain valid access_token", function () {
            pm.expect(jsonData.access_token).to.exist;
            oAuthToken = jsonData.access_token;
            console.log(oAuthToken);
            pm.globals.set("oAuthToken", oAuthToken);
          });

          var scope = pm.environment.get("scope");
          scope = scope.replace(/%20/gm, " ");

          pm.test(
            "Response should include all requested OAuth scopes",
            function () {
              pm.expect(jsonData.scope).to.equal(scope);
            }
          );
        },
        auth(config, Var) {
          const address = new URI(config.address);
          address.username("MULEINT");
          address.password(`${pm[Var]("muleint")}`);
          config.address = address.toString();
          config.options.auth = "basic";
        }
      });
    });

    group("Authentication", function () {
      postman[Request]({
        name: "GET unknown client_id returns 401",
        id: "f13b88e6-b589-4fa7-a3ca-c61275ba003d",
        method: "GET",
        address:
          "{{baseUrl}}/invoices/delegations?taskType={{taskType}}",
        headers: {
          client_id: "INVALID",
          client_secret: "{{client_secret}}",
          "X-CSRF-Token": "Fetch",
          Cookie: "{{Cookie}}"
        },
        post(response) {
          pm.test("Status code is 401", function () {
            pm.response.to.have.status(401);
          });
        },
        auth(config, Var) {
          config.headers.Authorization = `Bearer ${pm[Var]("oAuthToken")}`;
        }
      });

      postman[Request]({
        name: "GET unknown client_secret returns 401",
        id: "0007f5bc-befd-4562-ac4d-4d9f4636881e",
        method: "GET",
        address: "{{baseUrl}}/leaves/delegations?taskType={{taskType}}",
        headers: {
          client_id: "{{client_id}}",
          client_secret: "INVALID",
          "X-CSRF-Token": "Fetch",
          Cookie: "{{Cookie}}"
        },
        post(response) {
          pm.test("Status code is 401", function () {
            pm.response.to.have.status(401);
          });
        },
        auth(config, Var) {
          config.headers.Authorization = `Bearer ${pm[Var]("oAuthToken")}`;
        }
      });

      postman[Request]({
        name: "GET authenticated user returns 200",
        id: "2bdee66d-1775-4a62-913d-afb57e522f3d",
        method: "GET",
        address:
          "{{baseUrl}}/purchase-requisitions/tasks?offset={{offset}}&limit={{limit}}",
        headers: {
          client_id: "{{client_id}}",
          client_secret: "{{client_secret}}",
          Cookie: "{{Cookie}}",
          "X-Correlation-ID": "{{$guid}}"
        },
        post(response) {
          var SAP_Instance = pm.environment.get("SAP_Instance");

          pm.test("Status code is 200", function () {
            pm.response.to.have.status(200);
          });

          pm.test(
            "x-csrf-token header can be present in the response",
            function () {
              var xCsrfToken = null;
              for (const responseHeader in response.headers) {
                if (responseHeader.toLowerCase() === 'x-csrf-token') {
                  console.log(response.headers[responseHeader])
                  xCsrfToken = response.headers[responseHeader];
                  pm.globals.set("X-CSRF-Token", xCsrfToken);
                }
              }
              if (xCsrfToken == null) {
                pm.expect(false).equals(
                  true,
                  "X-CSRF-Token not found in the response headers"
                );
              }
            }
          );

          pm.test("Response can return a Cookie", function () {
            var Cookie = null;
            console.log(response.headers);
            for (const responseHeader in response.headers) {
              if (responseHeader.toLowerCase() === 'cookie') {
                console.log(response.headers[responseHeader])
                Cookie = response.headers[responseHeader];
              }
            }

            if (Cookie != null) {
              regex = new RegExp(`^(sap-XSRF_${SAP_Instance}_100=.*;) .ath.*`);
              Cookie = Cookie.match(regex)[1];
              pm.globals.set("Cookie", Cookie);
            } else {
              pm.expect(false).equals(
                true,
                "Cookie not found in the response headers"
              );
            }
          });
        },
        auth(config, Var) {
          config.headers.Authorization = `Bearer ${pm[Var]("oAuthToken")}`;
        }
      });
    });
  });
}
